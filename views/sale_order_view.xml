<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <record id="view_sale_order_form_crm_fields" model="ir.ui.view">
    <field name="name">sale.order.form.crm.fields</field>
    <field name="model">sale.order</field>
    <field name="inherit_id" ref="sale.view_order_form"/>
    <field name="arch" type="xml">

      <!-- =========================================================
           1) PESTAÑAS ADICIONALES
           ========================================================= -->
      
      <xpath expr="//notebook/page[@name='order_lines']" position="after">
        
        <!-- Nueva página: Gestión de Servicios -->
        <page string="Gestión de Servicios" name="service_management">
          
          <!-- Control global de servicios -->
          <group string="Configuración de Servicios">
            <field name="always_service"/>
          </group>

          <!-- Información del Servicio -->
          <group string="Información del Servicio">
            <group>
              <field name="service_frequency"/>
              <field name="pickup_location"/>
              <field name="final_destination"/>
            </group>
            <group>
              <field name="residue_new"/>
              <field name="requiere_visita"/>
            </group>
          </group>

          <!-- Información Básica del Prospecto -->
          <group string="Información Básica del Prospecto">
            <group>
              <field name="company_size"/>
              <field name="industrial_sector"/>
            </group>
            <group>
              <field name="prospect_priority"/>
              <field name="estimated_business_potential"/>
            </group>
          </group>

        </page>

        <page string="Informe General" name="general_report">

          <!-- Información Operativa -->
          <group string="Información Operativa">
            <group>
              <field name="access_restrictions" widget="text"/>
              <field name="allowed_collection_schedules" widget="text"/>
              <field name="current_container_types" widget="text"/>
            </group>
            <group>
              <field name="special_handling_conditions" widget="text"/>
              <field name="seasonality" widget="text"/>
            </group>
          </group>

          <!-- Información Regulatoria -->
          <group string="Información Regulatoria">
            <group>
              <field name="waste_generator_registration"/>
              <field name="environmental_authorizations" widget="text"/>
            </group>
            <group>
              <field name="quality_certifications" widget="text"/>
              <field name="other_relevant_permits" widget="text"/>
            </group>
          </group>

          <!-- Competencia y Mercado -->
          <group string="Competencia y Mercado">
            <group>
              <field name="current_service_provider"/>
              <field name="current_costs"/>
              <field name="current_provider_satisfaction"/>
            </group>
            <group>
              <field name="reason_for_new_provider" widget="text"/>
            </group>
          </group>

          <!-- Requerimientos Especiales -->
          <group string="Requerimientos Especiales">
            <group>
              <field name="specific_certificates_needed" widget="text"/>
              <field name="reporting_requirements" widget="text"/>
            </group>
            <group>
              <field name="service_urgency"/>
              <field name="estimated_budget"/>
            </group>
          </group>

          <!-- Campos de Seguimiento -->
          <group string="Seguimiento">
            <group>
              <field name="next_contact_date"/>
              <field name="pending_actions" widget="text"/>
            </group>
            <group>
              <field name="conversation_notes" widget="text"/>
            </group>
          </group>

        </page>
      </xpath>

      <!-- 2) Pestaña "Cotizaciones Relacionadas" -->
      <xpath expr="//notebook/page[@name='general_report']" position="after">
        <page string="Cotizaciones Relacionadas" name="related_quotations">
          
          <!-- Sección de referencia a cotización anterior -->
          <group string="Referencia">
            <field name="related_quotation_id" 
                   options="{'no_create': True}" 
                   placeholder="Seleccionar cotización anterior para este cliente..."/>
          </group>

          <!-- Botones de acción -->
          <div class="oe_button_box">
            <button type="object" 
                    name="action_view_child_quotations" 
                    class="oe_stat_button" 
                    icon="fa-list-alt"
                    invisible="child_quotations_count == 0">
              <field name="child_quotations_count" widget="statinfo" string="Cotizaciones Derivadas"/>
            </button>
          </div>

          <div class="row mt-3">
            <div class="col-12">
              <button type="object" 
                      name="action_create_related_quotation" 
                      string="Crear Nueva Cotización para este Cliente" 
                      class="btn btn-primary"
                      icon="fa-plus"/>
            </div>
          </div>

          <!-- Información de la cotización relacionada (solo lectura) -->
          <group string="Información de Cotización Relacionada" 
                 invisible="not related_quotation_id">
            <field name="related_quotation_id" invisible="1"/>
            <label for="related_quotation_id" string="Cotización Base:"/>
            <div class="o_row">
              <field name="related_quotation_id" readonly="1" nolabel="1"/>
            </div>
          </group>

          <!-- Lista de cotizaciones derivadas -->
          <group string="Cotizaciones Derivadas de esta Propuesta" 
                 invisible="child_quotations_count == 0">
            <field name="child_quotations_ids" nolabel="1" readonly="1">
              <list>
                <field name="name"/>
                <field name="partner_id"/>
                <field name="date_order"/>
                <field name="state"/>
                <field name="amount_total"/>
              </list>
            </field>
          </group>

        </page>
      </xpath>

      <!-- 3) Campos globales antes de Términos de pago -->
      <xpath expr="//field[@name='date_order']" position="before">
          <field name="expiration_date"/>
      </xpath>

      <!-- 4) Botón en el header -->
      <xpath expr="//header" position="inside">
        <button type="object" 
                name="action_create_related_quotation" 
                string="Nueva Cotización" 
                class="btn btn-secondary"
                invisible="state not in ['draft', 'sent']"
                help="Crear una nueva cotización para este cliente con nuevos residuos"/>
      </xpath>


      <!-- =========================================================
           5) MODIFICACIÓN LISTA DE LÍNEAS (ESTÉTICA CRM + FUNCIONALIDAD)
           ========================================================= -->
      
      <!-- Ocultamos las columnas originales para no borrarlas y perder referencias -->
      <xpath expr="//page[@name='order_lines']//list/field[@name='product_template_id']" position="attributes">
         <attribute name="column_invisible">True</attribute>
      </xpath>
      
      <!-- Ocultamos la descripción original para reinsertarla en nuestra posición deseada -->
      <xpath expr="//page[@name='order_lines']//list/field[@name='name']" position="attributes">
         <attribute name="column_invisible">True</attribute>
      </xpath>

      <!-- Insertamos nuestras columnas personalizadas al inicio -->
      <xpath expr="//page[@name='order_lines']//list/field[@name='product_template_id']" position="before">
        
        <!-- A. Lógica SERVICIO (Toggle y campos condicionales) -->
        <field name="create_new_service" 
               string="Nuevo" 
               widget="boolean_toggle" 
               width="60px"/>
        
        <!-- Opción A1: Escribir nombre (Visible si Nuevo=True) -->
        <field name="residue_name" 
               string="Nombre"
               invisible="not create_new_service"
               required="create_new_service"
               placeholder="Nombre del residuo..."
               width="150px"/>
        
        <!-- Opción A2: Seleccionar existente (Visible si Nuevo=False) -->
        <field name="existing_service_id"
               string="Existente"
               domain="[('sale_ok','=',True), ('type','=','service')]"
               options="{'no_create': True, 'no_open': True}"
               invisible="create_new_service"
               required="not create_new_service"
               placeholder="Buscar servicio..." 
               width="150px"/>
        <!-- D. DESCRIPCIÓN (Recuperada para permitir editar detalles de la partida) -->
        <field name="name" 
               string="Descripción" 
               widget="section_and_note_text" 
               optional="show"/>
        
        <!-- Informativos -->
        <field name="residue_type" string="Tipo" optional="show" width="80px"/>
        <field name="plan_manejo" string="Manejo" optional="show" width="100px"/>

        <!-- B. Lógica EMBALAJE (Toggle y campos condicionales) -->
        <field name="create_new_packaging" 
               string="Nuevo Emb." 
               widget="boolean_toggle"
               width="60px"/>
        
        <!-- Opción B1: Escribir nuevo embalaje (Visible si NuevoEmb=True) -->
        <field name="packaging_name" 
               string="Embalaje" 
               invisible="not create_new_packaging"
               required="create_new_packaging"
               placeholder="Ej: Tambor"
               width="100px"/>
        
        <!-- Opción B2: Seleccionar existente (Visible si NuevoEmb=False) -->
        <field name="residue_packaging_id" 
               string="Emb. Existente" 
               options="{'no_create': True}"
               invisible="create_new_packaging"
               required="not create_new_packaging"
               placeholder="Selec..."
               width="100px"/>

        <!-- C. Medidas y Totales -->
        <field name="residue_capacity" string="Capacidad" width="70px"/>
        <field name="residue_weight_kg" string="Peso(kg)" width="70px"/>
        <field name="residue_volume" string="Uds" width="70px" column_invisible="True"/>
        <field name="weight_per_unit" string="Kg/U" optional="hide" column_invisible="True"/>
        
        <!-- UoM (Informativo) -->
        <field name="residue_uom_id" string="UoM Base" optional="hide" column_invisible="True"/>
        
        
        
      </xpath>

      <!-- Agregar campos ocultos necesarios al final de la lista -->
      <xpath expr="//page[@name='order_lines']//list/field[@name='price_subtotal']" position="after">
        <field name="product_id" column_invisible="True"/>
        <field name="product_uom_id" column_invisible="True"/>
      </xpath>

      <!-- =========================================================
           6) FORMULARIO DE LÍNEA (DETALLE / POPUP)
           ========================================================= -->
      <xpath expr="//page[@name='order_lines']//form//field[@name='product_id']" position="after">
        
        <!-- Control de creación -->
        <group string="Configuración del Servicio">
          <group>
            <field name="create_new_service" widget="boolean_toggle"/>
            <field name="create_new_packaging" widget="boolean_toggle"/>
          </group>
        </group>
        
        <!-- Selección de servicio existente -->
        <group string="Servicio Existente" invisible="create_new_service">
          <field name="existing_service_id" 
                 options="{'no_create': True}"
                 placeholder="Buscar servicio existente..."/>
        </group>
        
        <!-- Campos para crear nuevo servicio -->
        <group string="Detalles del Residuo">
           <field name="residue_name" required="create_new_service"/>
           <field name="residue_type"/>
           <field name="plan_manejo"/>
        </group>

        <!-- Embalaje -->
        <group string="Embalaje">
           <field name="packaging_name" invisible="not create_new_packaging" required="create_new_packaging"/>
           <field name="residue_packaging_id" invisible="create_new_packaging"/>
        </group>
        
        <!-- Información de cantidades -->
        <group string="Medidas y Pesos">
          <group>
            <field name="residue_capacity" placeholder="Ej: 200 L"/>
            <field name="residue_volume" string="Número de Unidades"/>
          </group>
          <group>
            <field name="residue_weight_kg" string="Peso Total (kg)"/>
            <field name="weight_per_unit" readonly="1"/>
            <field name="residue_uom_id" readonly="1"/>
          </group>
        </group>
        
      </xpath>

    </field>
  </record>
</odoo>